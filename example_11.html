<!DOCTYPE html>
<!-- TODO! Turn off CORS so this works on Firefox. -->
<title>SVG Example</title>
<?xml version="1.0" encoding="utf-8" standalone="no"?>



<script type="module">
  // Parse CSV data
  import { town06_csv } from './raw_spawn_data.js';
  import { parse } from './escsv.js';

  //// Create SVG programatically so that polygons render!
  var container = document.createElement("div");
  var svg = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
  svg.setAttribute("width", "700");
  svg.setAttribute("height", "700");
  svg.setAttribute("id", "carmap");
  svg.setAttribute("viewbox", "0 0 700 700");

  // define defs, polygon
  var defs = document.createElementNS("http://www.w3.org/2000/svg", 'defs');
  var defs_polygon = document.createElementNS("http://www.w3.org/2000/svg", 'polygon');
  defs_polygon.setAttribute("id", "car");
  defs_polygon.setAttribute("class", "car");
  defs_polygon.setAttribute("points", "16,0 -16,-8 -24,0 -16,8");
  // add defs, polygon to the svg
  defs.appendChild(defs_polygon);
  svg.appendChild(defs);

  // Create the groups too...
  var map_g = document.createElementNS("http://www.w3.org/2000/svg", 'g');
  map_g.setAttribute("id","entire-map");
  var cars_g = document.createElementNS("http://www.w3.org/2000/svg", 'g');
  cars_g.setAttribute("id","cars");
  var grid_g = document.createElementNS("http://www.w3.org/2000/svg", 'g');
  grid_g.setAttribute("id","grid");
  grid_g.setAttribute("style","stroke:#94b0c2;");

  // Now add lines to the grid
  for (let ii = 0; ii < 20; ii++) {
    var h_line = document.createElementNS("http://www.w3.org/2000/svg", 'line');
    h_line.setAttribute("x1", "0");
    h_line.setAttribute("x2", "1000");
    h_line.setAttribute("y1", `${ii*50}`);
    h_line.setAttribute("y2", `${ii*50}`);

    var v_line = document.createElementNS("http://www.w3.org/2000/svg", 'line');
    v_line.setAttribute("y1", "0");
    v_line.setAttribute("y2", "1000");
    v_line.setAttribute("x1", `${ii*50}`);
    v_line.setAttribute("x2", `${ii*50}`);

    grid_g.appendChild(h_line);
    grid_g.appendChild(v_line);
  }

  // Now add these groups together, and then to the SVG
  map_g.appendChild(cars_g);
  map_g.appendChild(grid_g);
  svg.appendChild(map_g);
  // and finally, the svg to the doc
  container.appendChild(svg);
  document.body.appendChild(container);

  //// Functions used with listeners
  function shades(self, color) {
    return function () {self.style.fill = color}
  }

  function dotext(self, data) {
    return function () { navigator.clipboard.writeText(data); }
  }

  //// Add cars
  // 1. Load CSV
  var sp = parse(town06_csv);
  
  // 2. Add cars
  for (let ii = 0; ii < sp.length; ii++) {
    // Create a group to hold our car
    var car = document.createElementNS("http://www.w3.org/2000/svg", 'g');

    // get values out

    var x = sp[ii][0]
    var y = sp[ii][1]
    var z = sp[ii][2]
    var pitch = sp[ii][3]
    var yaw = sp[ii][4]
    var roll = sp[ii][5]

    car.setAttribute("id",`car${ii}`);
    car.setAttribute(
      "transform",`
      translate(${x},${y}) rotate(${yaw}) scale(.5)`
    );
    // add nested 'use'
    var use_car = document.createElementNS("http://www.w3.org/2000/svg", 'use');
    use_car.setAttribute("href", "#car");
    // Add to DOM
    car.appendChild(use_car);
    cars_g.appendChild(car);
    
    // TODO add listeners, data
    car.addEventListener('mouseover',  shades(car, '#3b5dc9'))
    car.addEventListener('mouseleave', shades(car, '#1a1c2c'))
    car.addEventListener('mousedown',  shades(car, '#ef7d57'))
    car.addEventListener('mouseup',    shades(car, '#3b5dc9'))

    // set up data string
    x = parseFloat(x).toFixed(3);
    y = parseFloat(y).toFixed(3);
    z = parseFloat(z).toFixed(3);
    pitch = parseFloat(pitch).toFixed(3);
    yaw = parseFloat(yaw).toFixed(3);
    roll = parseFloat(roll).toFixed(3);
    var carsdata = `[${x}, ${y}, ${z}, ${pitch}, ${yaw}, ${roll}]`;
    car.addEventListener('click',      dotext(car, carsdata));
  }
  

  /* TODO:
   * 1. Add road data
   * 2. Translate canvas
   * 3. Add all towns (and cleaner python script). Add option to choose town.
   * 4. Cleaner export-spawnpoints script..


  // also see:
  // http://stackoverflow.com/questions/2753732/  to access elements async
  */
</script>

</html>